# OpenOCD 配置文件 - IMC-22 (RISC-V)
# 用于调试和烧录

# 接口配置 (使用 J-Link)
# 如果使用其他调试器，修改此行

# adapter driver jlink
# adapter speed 4000

# 或使用 FT2232 (FTDI)
# adapter driver ftdi
# adapter speed 10000

# 目标芯片配置
set _CHIPNAME imc22
set _ENDIAN little
set _CPUTAPID 0x10000913

# RISC-V 配置
adapter speed 4000

# JTAG TAP 定义
jtag newtap $_CHIPNAME cpu -irlen 5 -expected-id $_CPUTAPID

# 目标定义
set _TARGETNAME $_CHIPNAME.cpu
target create $_TARGETNAME riscv -endian $_ENDIAN -chain-position $_TARGETNAME

# RISC-V 特定配置
$_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size 0x10000 -work-area-backup 0

# FLASH 配置 (NOR Flash)
set _FLASHNAME $_CHIPNAME.flash
flash bank $_FLASHNAME stm32f2x 0x08000000 0x200000 0 0 $_TARGETNAME

# 复位配置
$_TARGETNAME configure -event reset-init {
    # 停止并复位
    halt
    
    # 初始化系统时钟
    # (根据实际硬件调整)
    
    # 使能 FLASH 写入
    flash probe 0
}

# 调试辅助函数
proc imc22_reset {} {
    reset halt
    sleep 100
}

proc imc22_flash_firmware {filename} {
    # 擦除
    flash erase_address 0x08000000 0x100000
    
    # 烧录
    flash write_image $filename 0x08000000
    
    # 验证
    verify_image $filename 0x08000000
    
    # 复位并运行
    reset run
}

# 打印配置信息
echo "IMC-22 OpenOCD 配置加载完成"
echo "使用方法:"
echo "  openocd -f imc22.cfg"
echo "  telnet localhost 4444"
echo "  > imc22_flash_firmware firmware.bin"
